[@concept-design-overview](../../background/concept-design-overview.md)

[@concept-specifications](../../background/concept-specifications.md)

[@implementing-concepts](../../background/implementing-concepts.md)

# implement: implement this in type script ListingConcept

# Listing Concept

**concept** Listing

**purpose**  represent a summer-housing listing posted by an MIT-affiliated lister, including address, availability window, pricing, amenities, and photos

**principle** after a user creates a listing for their summer housing options, other users can browse listings to find housing easily

**state**

        a set of Listings with
            _id ID
            a title String
            a lister User
            a set of Amenities
            a photos set of Images
            an address String // post the address or wait until they reach out?
            a startDate DateTime
            an endDate DateTime
            a price Number // could be week by week or something else - good to be consitent


        a set of Amenities with
            _id ID
            a title String
            a distance Number

**actions**

        create(lister: User, amenities: set of Amenities, photos: set of Images, address: String, startDate: DateTime, endDate: DateTime, price: Number) : (newListing: Listing)
            requires:
                - no listing with this address and for these dates exists
                - startDate < endDate
            effects: creates and returns a new listing with the given lister, amenities, photos, address, startDate, endDate, and price

        delete(_id: ID)
            requires: listing with this _id exists
            effects: deletes the listing from the set of listings

        deletePhoto(listing: ID, photo: Image) : (editedListing: Listing)
            requires:
                - listing exists
                - photo is in this listing's photos
            effects: removes the photo from the listing's photos attribute and returns listing

        addPhoto(listing: ID, photo: Image) : (editedListing: Listing)
            requires:
                - listing exists
                - photo is not in the listing
            effects: adds the photo to the listings photos attribute and returns listing

        editTitle(listing: ID, newTitle: String) : (editedListing: Listing)
            requires:
                - listing exists
            effects: changes the title to newTitle and returns listing

        editAddress(listing: ID, newAddress: String) : (editedListing: Listing)
            requires:
                - listing exists
                - another listing with the same startDate and EndDate does not exist with this address
            effects: changes the address to newAddress and returns listing

        editStartDate(listing: ID, newStartDate: DateTime) : (editedListing: Listing)
            requires:
                - listing exists
                - another listing with the same address and EndDate does not exist with this startDate
                - startDate < endDate
            effects: changes the startDate to newStartDate and returns listing

        editEndDate(listing: ID, newEndDate: DateTime) : (editedListing: Listing)
            requires:
                - listing exists
                - another listing with the same address and StartDate does not exist with this endDate
                - startDate < endDate
            effects: changes the endDate to newEndDate and returns listing

        editPrice(listing: ID, newPrice: Number) : (editedListing: Listing)
            requires: listing exists
            effects: changes the price to newPrice and returns listing

        addAmenity(listing: ID, title: String, distance: Number)
            requires:
                - listing exists
                - amenity is not already in amenities
            effects: add the amenity to the amenities attribute

        deleteAmenity(listing: ID, amenity: ID)
            requires:
                - listing exists
                - amenity is part of the listing
            effects: removes amenity from amenities

# response:


# response:

To implement the `ListingConcept` in TypeScript, we'll define the necessary interfaces for `User`, `Image`, `Amenity`, and `Listing`, and then create a `ListingConcept` class that encapsulates the state (a collection of listings) and the defined actions.

We'll use `uuid` for generating unique IDs, which you'd typically install via `npm install uuid`.

```typescript
// --- 0. Required Imports ---
import { v4 as uuidv4 } from 'uuid'; // For generating unique IDs

// --- 1. Helper Types and Interfaces ---

/**
 * Type alias for unique identifiers.
 */
type ID = string;

/**
 * Represents an MIT-affiliated user who can post listings.
 * (This is a simplified interface; a full system would have more properties).
 */
interface User {
  _id: ID;
  name: string;
  // Add other relevant user properties if needed, e.g., 'email', 'kerb'
}

/**
 * Represents an image associated with a listing.
 */
interface Image {
  _id: ID;
  url: string;
  alt?: string; // Optional alternative text for accessibility
}

/**
 * Represents an amenity available for a listing.
 * As per the concept, amenities are created specific to a listing
 * with a title and a distance (e.g., distance from the listing).
 */
interface Amenity {
  _id: ID;
  title: string;
  distance: number; // e.g., distance in miles/km from MIT or another reference point
}

/**
 * Represents a summer-housing listing.
 */
interface Listing {
  _id: ID;
  title: string;
  lister: User;
  amenities: Amenity[];
  photos: Image[];
  address: string;
  startDate: Date;
  endDate: Date;
  price: number; // e.g., price per week or per month
}

// --- 2. ListingConcept Implementation ---

/**
 * Manages the state and actions related to summer housing listings.
 */
class ListingConcept {
  // A private map to store listings, keyed by their unique ID for efficient lookup.
  private listings: Map<ID, Listing>;

  constructor() {
    this.listings = new Map<ID, Listing>();
  }

  /**
   * Internal helper to retrieve a listing by its ID, throwing an error if not found.
   * @param listingId The ID of the listing to retrieve.
   * @returns The found Listing object.
   * @throws Error if the listing does not exist.
   */
  private getListing(listingId: ID): Listing {
    const listing = this.listings.get(listingId);
    if (!listing) {
      throw new Error(`Listing with ID '${listingId}' not found.`);
    }
    return listing;
  }

  /**
   * Checks for conflicts (overlapping address and dates) with existing listings.
   * @param address The address to check.
   * @param startDate The start date to check.
   * @param endDate The end date to check.
   * @param excludeListingId Optional ID of a listing to exclude from the conflict check (useful during edits).
   * @returns True if a conflict exists, false otherwise.
   */
  private isListingConflict(address: string, startDate: Date, endDate: Date, excludeListingId?: ID): boolean {
    for (const listing of this.listings.values()) {
      if (listing._id === excludeListingId) {
        continue; // Skip the listing being edited
      }

      // Check if addresses match
      if (listing.address === address) {
        // Check for date overlap: (start1 <= end2) AND (end1 >= start2)
        const datesOverlap = (
          listing.startDate.getTime() <= endDate.getTime() &&
          listing.endDate.getTime() >= startDate.getTime()
        );

        if (datesOverlap) {
          return true; // Conflict found
        }
      }
    }
    return false;
  }

  // --- 3. Actions Implementation ---

  /**
   * Creates and registers a new summer housing listing.
   * @param lister The user posting the listing.
   * @param amenities A set of amenities for the listing.
   * @param photos A set of photos for the listing.
   * @param address The physical address of the housing.
   * @param startDate The start date of availability.
   * @param endDate The end date of availability.
   * @param price The price of the listing.
   * @returns The newly created Listing.
   * @throws Error if creation requirements are not met (e.g., date order, address/date conflict).
   */
  create(
    lister: User,
    amenities: Amenity[],
    photos: Image[],
    address: string,
    startDate: Date,
    endDate: Date,
    price: number
  ): Listing {
    // Requires: startDate < endDate
    if (startDate >= endDate) {
      throw new Error('Create listing failed: Start date must be strictly before end date.');
    }
    // Requires: no listing with this address and for these dates exists
    if (this.isListingConflict(address, startDate, endDate)) {
      throw new Error(`Create listing failed: A listing with address '${address}' overlaps with the specified dates.`);
    }
    if (price < 0) {
        throw new Error('Create listing failed: Price cannot be negative.');
    }

    const newListing: Listing = {
      _id: uuidv4(),
      title: `${address} - ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`, // Default title
      lister,
      amenities: [...amenities], // Store a shallow copy to prevent external mutation
      photos: [...photos],       // Store a shallow copy
      address,
      startDate,
      endDate,
      price,
    };

    this.listings.set(newListing._id, newListing);
    return { ...newListing }; // Return a shallow copy of the new listing
  }

  /**
   * Deletes an existing listing by its ID.
   * @param id The ID of the listing to delete.
   * @throws Error if the listing does not exist.
   */
  delete(id: ID): void {
    // Requires: listing with this _id exists
    if (!this.listings.has(id)) {
      throw new Error(`Delete listing failed: Listing with ID '${id}' not found.`);
    }
    this.listings.delete(id);
  }

  /**
   * Removes a photo from a listing.
   * @param listingId The ID of the listing to modify.
   * @param photoId The ID of the photo to remove.
   * @returns The updated Listing.
   * @throws Error if the listing or photo does not exist within the listing.
   */
  deletePhoto(listingId: ID, photoId: ID): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists

    const initialPhotoCount = listing.photos.length;
    listing.photos = listing.photos.filter(p => p._id !== photoId);

    // Requires: photo is in this listing's photos
    if (listing.photos.length === initialPhotoCount) {
      throw new Error(`Delete photo failed: Photo with ID '${photoId}' not found in listing '${listingId}'.`);
    }

    return { ...listing };
  }

  /**
   * Adds a new photo to a listing.
   * @param listingId The ID of the listing to modify.
   * @param photo The Image object to add.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist or the photo is already present.
   */
  addPhoto(listingId: ID, photo: Image): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists

    // Requires: photo is not in the listing (check by ID or URL for robust uniqueness)
    if (listing.photos.some(p => p._id === photo._id || p.url === photo.url)) {
      throw new Error(`Add photo failed: Photo with ID '${photo._id}' or URL '${photo.url}' already exists in listing '${listingId}'.`);
    }

    listing.photos.push(photo);
    return { ...listing };
  }

  /**
   * Changes the title of a listing.
   * @param listingId The ID of the listing to modify.
   * @param newTitle The new title for the listing.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist.
   */
  editTitle(listingId: ID, newTitle: string): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists
    listing.title = newTitle;
    return { ...listing };
  }

  /**
   * Changes the address of a listing.
   * @param listingId The ID of the listing to modify.
   * @param newAddress The new address for the listing.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist or if the new address causes a conflict.
   */
  editAddress(listingId: ID, newAddress: string): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists

    // Requires: another listing with the same startDate and EndDate does not exist with this address
    if (this.isListingConflict(newAddress, listing.startDate, listing.endDate, listingId)) {
      throw new Error(`Edit address failed: Another listing with address '${newAddress}' overlaps with the current listing's dates.`);
    }

    listing.address = newAddress;
    return { ...listing };
  }

  /**
   * Changes the start date of a listing.
   * @param listingId The ID of the listing to modify.
   * @param newStartDate The new start date for the listing.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist or if the new start date causes a conflict or is invalid.
   */
  editStartDate(listingId: ID, newStartDate: Date): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists

    // Requires: startDate < endDate
    if (newStartDate >= listing.endDate) {
      throw new Error('Edit start date failed: New start date must be strictly before the current end date.');
    }
    // Requires: another listing with the same address and EndDate does not exist with this startDate
    if (this.isListingConflict(listing.address, newStartDate, listing.endDate, listingId)) {
      throw new Error(`Edit start date failed: Another listing with the same address overlaps with the new start date and current end date.`);
    }

    listing.startDate = newStartDate;
    return { ...listing };
  }

  /**
   * Changes the end date of a listing.
   * @param listingId The ID of the listing to modify.
   * @param newEndDate The new end date for the listing.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist or if the new end date causes a conflict or is invalid.
   */
  editEndDate(listingId: ID, newEndDate: Date): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists

    // Requires: startDate < endDate
    if (listing.startDate >= newEndDate) {
      throw new Error('Edit end date failed: Current start date must be strictly before the new end date.');
    }
    // Requires: another listing with the same address and StartDate does not exist with this endDate
    if (this.isListingConflict(listing.address, listing.startDate, newEndDate, listingId)) {
      throw new Error(`Edit end date failed: Another listing with the same address overlaps with the current start date and new end date.`);
    }

    listing.endDate = newEndDate;
    return { ...listing };
  }

  /**
   * Changes the price of a listing.
   * @param listingId The ID of the listing to modify.
   * @param newPrice The new price for the listing.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist or if the price is invalid (e.g., negative).
   */
  editPrice(listingId: ID, newPrice: number): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists
    if (newPrice < 0) {
        throw new Error('Edit price failed: Price cannot be negative.');
    }
    listing.price = newPrice;
    return { ...listing };
  }

  /**
   * Adds a new amenity to a listing. This creates a new Amenity instance specific to the listing.
   * @param listingId The ID of the listing to modify.
   * @param title The title of the amenity.
   * @param distance The distance associated with the amenity.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist or an identical amenity already exists in the listing.
   */
  addAmenity(listingId: ID, title: string, distance: number): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists

    // Requires: amenity is not already in amenities (check by title and distance)
    if (listing.amenities.some(a => a.title === title && a.distance === distance)) {
      throw new Error(`Add amenity failed: Amenity '${title}' with distance '${distance}' already exists in listing '${listingId}'.`);
    }

    const newAmenity: Amenity = {
      _id: uuidv4(), // Generate a unique ID for this amenity instance
      title,
      distance,
    };
    listing.amenities.push(newAmenity);
    return { ...listing };
  }

  /**
   * Deletes an amenity from a listing by its ID.
   * @param listingId The ID of the listing to modify.
   * @param amenityId The ID of the amenity to remove.
   * @returns The updated Listing.
   * @throws Error if the listing does not exist or the amenity is not part of the listing.
   */
  deleteAmenity(listingId: ID, amenityId: ID): Listing {
    const listing = this.getListing(listingId); // Requires: listing exists

    const initialAmenityCount = listing.amenities.length;
    listing.amenities = listing.amenities.filter(a => a._id !== amenityId);

    // Requires: amenity is part of the listing
    if (listing.amenities.length === initialAmenityCount) {
      throw new Error(`Delete amenity failed: Amenity with ID '${amenityId}' not found in listing '${listingId}'.`);
    }

    return { ...listing };
  }

  // --- 4. Read/Query Methods (for completeness, not in original concept) ---

  /**
   * Retrieves a listing by its ID.
   * @param listingId The ID of the listing.
   * @returns The listing if found, otherwise undefined. Returns a shallow copy.
   */
  getListingById(listingId: ID): Listing | undefined {
    const listing = this.listings.get(listingId);
    return listing ? { ...listing } : undefined;
  }

  /**
   * Retrieves all current listings.
   * @returns An array of all listings. Returns shallow copies.
   */
  getAllListings(): Listing[] {
    return Array.from(this.listings.values()).map(l => ({ ...l }));
  }
}

// --- Example Usage (Optional) ---
/*
// Create a dummy user
const user1: User = { _id: uuidv4(), name: 'Alice Smith' };
const user2: User = { _id: uuidv4(), name: 'Bob Johnson' };

const listingManager = new ListingConcept();

try {
  // Create a listing
  const listing1 = listingManager.create(
    user1,
    [{ _id: uuidv4(), title: 'WiFi', distance: 0.1 }],
    [{ _id: uuidv4(), url: 'http://example.com/pic1.jpg' }],
    '123 Main St, Cambridge MA',
    new Date('2024-06-01'),
    new Date('2024-08-31'),
    1500
  );
  console.log('Created Listing 1:', listing1);

  // Try to create a conflicting listing
  try {
    listingManager.create(
      user2,
      [],
      [],
      '123 Main St, Cambridge MA', // Same address
      new Date('2024-07-01'), // Overlapping dates
      new Date('2024-09-01'),
      1600
    );
  } catch (error: any) {
    console.warn('Expected error:', error.message);
  }

  // Edit title
  const updatedListing1 = listingManager.editTitle(listing1._id, 'Cozy Apartment Near MIT');
  console.log('Edited Title:', updatedListing1.title);

  // Add amenity
  const listing1WithParking = listingManager.addAmenity(listing1._id, 'Free Parking', 0);
  console.log('Listing 1 Amenities:', listing1WithParking.amenities);

  // Add photo
  const photo2: Image = { _id: uuidv4(), url: 'http://example.com/pic2.jpg' };
  const listing1WithPhoto2 = listingManager.addPhoto(listing1._id, photo2);
  console.log('Listing 1 Photos:', listing1WithPhoto2.photos.length);

  // Delete photo
  const listing1WithoutPhoto1 = listingManager.deletePhoto(listing1._id, listing1.photos[0]._id);
  console.log('Listing 1 Photos after deletion:', listing1WithoutPhoto1.photos.length);

  // Delete amenity
  const listing1WithoutParking = listingManager.deleteAmenity(listing1._id, listing1WithParking.amenities[1]._id);
  console.log('Listing 1 Amenities after deletion:', listing1WithoutParking.amenities);

  // Edit price
  const listing1NewPrice = listingManager.editPrice(listing1._id, 1400);
  console.log('Listing 1 New Price:', listing1NewPrice.price);

  // Get all listings
  console.log('All Listings:', listingManager.getAllListings());

  // Delete listing
  listingManager.delete(listing1._id);
  console.log('Listing 1 deleted.');

  // Try to get deleted listing
  console.log('Listing 1 after deletion:', listingManager.getListingById(listing1._id));

} catch (error: any) {
  console.error('An unexpected error occurred:', error.message);
}
*/
```